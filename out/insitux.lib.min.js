(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.d(t,{invoker:()=>jr});var r={};e.r(r),e.d(r,{abs:()=>O,acos:()=>U,asin:()=>W,atan:()=>X,ceil:()=>Q,charCode:()=>P,codeChar:()=>M,concat:()=>A,cos:()=>_,cosh:()=>V,ends:()=>y,flat:()=>b,floor:()=>J,getTimeMs:()=>S,has:()=>f,isArray:()=>i,isNum:()=>u,len:()=>c,log10:()=>re,log2:()=>te,logn:()=>ee,lowerCase:()=>$,max:()=>F,min:()=>T,objKeys:()=>N,padEnd:()=>I,push:()=>g,randInt:()=>q,randNum:()=>D,range:()=>H,replace:()=>x,reverse:()=>k,round:()=>G,rreplace:()=>h,sign:()=>Z,sin:()=>R,sinh:()=>L,slen:()=>o,slice:()=>a,sortBy:()=>C,splice:()=>s,sqrt:()=>Y,starts:()=>d,strIdx:()=>p,sub:()=>m,subIdx:()=>v,substr:()=>l,tan:()=>z,tanh:()=>K,toNum:()=>n,trim:()=>j,trimEnd:()=>B,trimStart:()=>E,upperCase:()=>w});const n=e=>Number(e),a=(e,t,r)=>e.slice(t,r),s=(e,t,r)=>e.splice(t,r),c=e=>e.length,o=e=>e.length,u=e=>""!==e&&!Number.isNaN(Number(e)),i=e=>Array.isArray(e),l=(e,t,r)=>e.substring(t,t+(r??e.length)),p=(e,t)=>e[t],m=(e,t)=>e.includes(t),v=(e,t)=>e.indexOf(t),f=(e,t)=>e.includes(t),d=(e,t)=>e.startsWith(t),y=(e,t)=>e.endsWith(t),x=(e,t,r)=>e.split(t).join(r),h=(e,t,r)=>e.replace(new RegExp(t,"g"),r),b=e=>e.flat(),A=(e,t)=>e.concat(t),g=(e,t)=>e.push(...t),C=(e,t)=>e.sort(t),k=e=>e.reverse(),$=e=>e.toLowerCase(),w=e=>e.toUpperCase(),j=e=>e.trim(),E=e=>e.trimStart(),B=e=>e.trimEnd(),I=(e,t)=>e.padEnd(t),P=e=>e.charCodeAt(0),M=e=>String.fromCharCode(e),D=(e,t)=>e+Math.random()*(t-e),q=(e,t)=>Math.floor(D(e,t)),H=e=>[...Array(e).keys()],N=e=>Object.keys(e),S=()=>(new Date).getTime(),O=Math.abs,T=Math.min,F=Math.max,R=Math.sin,_=Math.cos,z=Math.tan,L=Math.sinh,V=Math.cosh,K=Math.tanh,W=Math.asin,U=Math.acos,X=Math.atan,Y=Math.sqrt,G=Math.round,J=Math.floor,Q=Math.ceil,Z=Math.sign,ee=Math.log,te=Math.log2,re=Math.log10,ne={print:{returns:["null"]},"print-str":{returns:["null"]},"!":{exactArity:1,returns:["bool"]},"=":{minArity:2,returns:["bool"]},"!=":{minArity:2,returns:["bool"]},"+":{minArity:2,numeric:!0},"-":{minArity:2,numeric:!0},"*":{minArity:2,numeric:!0},"/":{minArity:2,numeric:!0},"//":{minArity:2,numeric:!0},"**":{minArity:1,maxArity:2,numeric:!0},"<":{minArity:2,numeric:"in only",returns:["bool"]},">":{minArity:2,numeric:"in only",returns:["bool"]},"<=":{minArity:2,numeric:"in only",returns:["bool"]},">=":{minArity:2,numeric:"in only",returns:["bool"]},"str<":{minArity:2,returns:["bool"]},"str>":{minArity:2,returns:["bool"]},"str<=":{minArity:2,returns:["bool"]},"str>=":{minArity:2,returns:["bool"]},"fast=":{exactArity:2,returns:["bool"]},"fast!=":{exactArity:2,returns:["bool"]},"fast+":{exactArity:2,numeric:!0},"fast-":{exactArity:2,numeric:!0},"fast*":{exactArity:2,numeric:!0},"fast/":{exactArity:2,numeric:!0},"fast//":{exactArity:2,numeric:!0},"fast<":{exactArity:2,numeric:"in only",returns:["bool"]},"fast>":{exactArity:2,numeric:"in only",returns:["bool"]},"fast<=":{exactArity:2,numeric:"in only",returns:["bool"]},"fast>=":{exactArity:2,numeric:"in only",returns:["bool"]},neg:{exactArity:1,numeric:!0},inc:{exactArity:1,numeric:!0},dec:{exactArity:1,numeric:!0},min:{minArity:2,numeric:!0},max:{minArity:2,numeric:!0},abs:{exactArity:1,numeric:!0},sqrt:{exactArity:1,numeric:!0},round:{minArity:1,maxArity:2,numeric:!0},floor:{exactArity:1,numeric:!0},ceil:{exactArity:1,numeric:!0},logn:{exactArity:1,numeric:!0},log2:{exactArity:1,numeric:!0},log10:{exactArity:1,numeric:!0},and:{minArity:1},or:{minArity:1},xor:{exactArity:2},"&":{exactArity:2,numeric:!0},"|":{exactArity:2,numeric:!0},"^":{exactArity:2,numeric:!0},"~":{exactArity:1,numeric:!0},"<<":{exactArity:2,numeric:!0},">>":{exactArity:2,numeric:!0},">>>":{exactArity:2,numeric:!0},"odd?":{exactArity:1,numeric:"in only",returns:["bool"]},"even?":{exactArity:1,numeric:"in only",returns:["bool"]},"pos?":{exactArity:1,numeric:"in only",returns:["bool"]},"neg?":{exactArity:1,numeric:"in only",returns:["bool"]},"zero?":{exactArity:1,numeric:"in only",returns:["bool"]},"null?":{exactArity:1,returns:["bool"]},"num?":{exactArity:1,returns:["bool"]},"bool?":{exactArity:1,returns:["bool"]},"str?":{exactArity:1,returns:["bool"]},"vec?":{exactArity:1,returns:["bool"]},"dict?":{exactArity:1,returns:["bool"]},"key?":{exactArity:1,returns:["bool"]},"func?":{exactArity:1,returns:["bool"]},"wild?":{exactArity:1,returns:["bool"]},"ext?":{exactArity:1,returns:["bool"]},"type-of":{exactArity:1,returns:["str"]},rem:{minArity:2,numeric:!0},sin:{exactArity:1,numeric:!0},cos:{exactArity:1,numeric:!0},tan:{exactArity:1,numeric:!0},asin:{exactArity:1,numeric:!0},acos:{exactArity:1,numeric:!0},atan:{exactArity:1,numeric:!0},sinh:{exactArity:1,numeric:!0},cosh:{exactArity:1,numeric:!0},tanh:{exactArity:1,numeric:!0},vec:{returns:["vec"]},dict:{returns:["dict"]},len:{exactArity:1,params:[["str","vec","dict"]],returns:["num"]},"to-num":{exactArity:1,params:[["str","num"]],returns:["num","null"]},"to-key":{exactArity:1,params:[["str","num"]],returns:["key"]},"to-vec":{exactArity:1,params:[["str","dict"]],returns:["vec"]},"substr?":{exactArity:2,params:["str","str"],returns:["bool"]},idx:{exactArity:2,params:["any",["str","vec"]],returns:["num"]},"set-at":{exactArity:3,params:["vec","any",["vec","dict"]],returns:["vec","dict"]},"update-at":{exactArity:3,params:["vec","any",["vec","dict"]],returns:["vec","dict"]},juxt:{returns:["clo"]},"pos-juxt":{returns:["clo"]},map:{minArity:2,returns:["vec"]},for:{minArity:2,returns:["vec"]},reduce:{minArity:2,maxArity:3},reductions:{minArity:2,maxArity:3},filter:{minArity:2,params:["any",["vec","dict","str"]],returns:["vec","str","dict"]},remove:{minArity:2,params:["any",["vec","dict","str"]],returns:["vec","str","dict"]},find:{minArity:2,params:["any",["vec","dict","str"]]},count:{minArity:2,params:["any",["vec","dict","str"]],returns:["num"]},repeat:{minArity:2,params:["any","num"]},times:{minArity:2,params:["num","any"]},str:{returns:["str"]},strn:{returns:["str"]},rand:{maxArity:2,numeric:!0,returns:["num"]},"rand-int":{maxArity:2,numeric:!0,returns:["num"]},".":{minArity:1},"..":{minArity:2},"...":{minArity:2},into:{exactArity:2,params:[["vec","dict"],["vec","dict"]],returns:["vec","dict"]},assoc:{exactArity:3,params:["any","any","dict"],returns:["dict"]},omit:{exactArity:2,params:["any","dict"],returns:["dict"]},drop:{exactArity:2,params:["num","vec"],returns:["vec"]},insert:{exactArity:3,params:["any","num","vec"],returns:["vec"]},append:{exactArity:2,params:["any","vec"],returns:["vec"]},prepend:{exactArity:2,params:["any","vec"],returns:["vec"]},sect:{minArity:1,maxArity:3,params:[["vec","str"],"num","num"],returns:["vec","str"]},skip:{exactArity:2,params:["num",["vec","str"]],returns:["vec","str"]},first:{exactArity:2,params:["num",["vec","str"]],returns:["vec","str"]},last:{exactArity:2,params:["num",["vec","str"]],returns:["vec","str"]},crop:{exactArity:3,params:["num","num",["vec","str"]],returns:["vec","str"]},reverse:{exactArity:1,params:[["vec","str"]],returns:["vec","str"]},flatten:{exactArity:1,params:["vec"],returns:["vec"]},shuffle:{exactArity:1,params:["vec"],returns:["vec"]},sample:{exactArity:2,params:["num","vec"],returns:["vec"]},sort:{exactArity:1,params:[["vec","str"]],returns:["vec"]},"sort-by":{exactArity:2,params:["any",["vec","dict","str"]],returns:["vec"]},distinct:{returns:["vec"]},"group-by":{exactArity:2,params:["any",["vec","dict","str"]],returns:["dict"]},"part-by":{exactArity:2,params:["any",["vec","dict","str"]],returns:["vec"]},freqs:{exactArity:1,params:[["vec","str"]],returns:["dict"]},keys:{exactArity:1,params:["dict"]},vals:{exactArity:1,params:["dict"]},do:{minArity:1},val:{minArity:1},range:{minArity:1,maxArity:3,numeric:"in only",returns:["vec"]},"empty?":{exactArity:1,params:[["str","vec","dict"]],returns:["bool"]},split:{exactArity:2,params:["str","str"],returns:["vec"]},join:{exactArity:2,params:["str",["vec","dict","str"]],returns:["str"]},replace:{exactArity:3,params:["str","str","str"],returns:["str"]},rreplace:{exactArity:3,params:["str","str","str"],returns:["str"]},"starts?":{exactArity:2,params:["str","str"],returns:["bool"]},"ends?":{exactArity:2,params:["str","str"],returns:["bool"]},"lower-case":{exactArity:1,params:["str"],returns:["str"]},"upper-case":{exactArity:1,params:["str"],returns:["str"]},trim:{exactArity:1,params:["str"],returns:["str"]},"trim-start":{exactArity:1,params:["str"],returns:["str"]},"trim-end":{exactArity:1,params:["str"],returns:["str"]},"str*":{exactArity:2,params:["str","num"],returns:["str"]},"char-code":{minArity:1,maxArity:2,params:[["str","num"],"num"],returns:["str","num","null"]},time:{exactArity:0,returns:["num"]},version:{exactArity:0,returns:["num"]},tests:{minArity:0,maxArity:1,params:["bool"],returns:["str"]},symbols:{exactArity:0,returns:["vec"]},eval:{exactArity:1,params:["str"]},about:{exactArity:1,params:[["str","func"]],returns:["dict"]},reset:{exactArity:0},recur:{}},ae=["function","fn","var","let","var!","let!","return","if","if!","when","unless","while","loop","match","satisfy","catch"],se={null:"null",str:"string",num:"number",bool:"boolean",key:"keyword",ref:"reference",vec:"vector",dict:"dictionary",func:"function",clo:"closure",wild:"wildcard",ext:"external"},ce=e=>"bool"===e.t?e.v:"null"!==e.t;function oe(e,t,r){const{exactArity:n,maxArity:a,minArity:s}=ne[e],c=(n,a)=>[{e:"Arity",m:`${e} needs ${n} argument${1!==a?"s":""}, not ${t}`,errCtx:r}];if(void 0!==n){if(t!==n)return c(`exactly ${n}`,n)}else{if(s&&!a&&t<s)return c(`at least ${s}`,s);if(!s&&a&&t>a)return c(`at most ${a}`,a);if(s&&a&&(t<s||t>a))return c(`between ${s} and ${a}`,a)}}function ue(e,t,r,n=!1){const{params:a,numeric:s}=ne[e],o=c(t);if(s){const a=t.findIndex((e=>!!c(e)&&(n?!e.find((e=>"num"===e)):"num"!==e[0])));if(-1===a)return;const s=t[a].map((e=>se[e])).join(", ");return[ie(`${e} takes numeric arguments only, not ${s}`,r)]}if(!a)return;const u=a.map(((e,r)=>{if(r>=o||!t[r]||"any"===e)return!1;const a=t[r];if(i(e)){if(n?!c(a)||a.some((t=>f(e,t))):1===c(a)&&f(e,a[0]))return!1;const t=a.map((e=>se[e]));return`argument ${r+1} must be either: ${e.map((e=>se[e])).join(", ")}, not ${t}`}{if(n?!c(a)||f(a,e):1===c(a)&&e===a[0])return!1;const t=a.map((e=>se[e]));return`argument ${r+1} must be ${se[e]}, not ${t}`}})).filter((e=>!!e));return c(u)?u.map((e=>ie(e,r))):void 0}const ie=(e,t)=>({e:"Type",m:e,errCtx:t});function le(e,t){const r=t.map((e=>se[e])).join(", ");return[ie(`number as operation argument must be string, vector, or dictionary, not ${r}`,e)]}function pe(e,t){const r=t.map((e=>se[e])).join(", ");return[ie(`keyword as operation argument must be dictionary or vector, not ${r}`,e)]}function me({name:e,length:t,captures:r,derefs:n},a,s){if(!c(s))return{name:e,ins:a};const o=[],u=n.map((e=>e.errCtx));for(let e=0;e<t;++e)r[e]?o.push({typ:"val",value:s.shift(),errCtx:u.shift()}):o.push(a[e]);return{name:e,ins:o}}function ve(e,t,r){return r&&"val"===t.typ&&"str"===t.value.t&&"exe"===r.typ||"npa"===t.typ&&!f(e,t.text)||"ref"===t.typ&&!f(e,t.value)}const{has:fe,flat:de,push:ye,slice:xe,splice:he}=r,{slen:be,starts:Ae,sub:ge,substr:Ce,strIdx:ke,subIdx:$e}=r,{isNum:we,len:je,toNum:Ee}=r,Be={t:"null",v:void 0},Ie={t:"bool",v:!1},Pe=e=>!!e&&"errCtx"in e,Me=(e,t=0)=>{if(Pe(e))return"";const r=e[t];return Pe(r)&&fe(["sym","str"],r.typ)&&r.text||""};function De(e){const t=Me(e,0),r=fe(["#","@"],t);return r&&(e=xe(e,1)),`${r?t:""}(${e.map((e=>Pe(e)?(({typ:e,text:t})=>"str"===e?`"${t}"`:t)(e):De(e))).join(" ")})`}const qe=e=>{if(1===je(e))return de(e);const t=e[je(e)-1],r=xe(e,0,je(e)-1),n={typ:"pop",value:je(r),errCtx:t[0].errCtx};return de([...r,[n],t])},He=(e,t)=>Pe(e)?Se(e,t):Ne(e,t);function Ne(e,t,r=!0){if(!je(e))return[];const n=e=>He(e,t);let a=e.shift(),s=n(a);const{errCtx:o}=s[0];if(Pe(a)&&"sym"===a.typ){if(a.text in ne){const{exactArity:t,minArity:r}=ne[a.text],n=t??r;n&&1!==n&&je(e)+1===n&&(e.unshift(a),a={typ:"sym",text:"@",errCtx:a.errCtx})}fe(["var","let"],a.text)&&je(e)&&je(e)%2&&(e.unshift(a),e.push({typ:"sym",text:"%",errCtx:a.errCtx}),a={typ:"sym",text:"#",errCtx:a.errCtx});const{text:o,errCtx:u}=a,i=(e,t=u)=>[{typ:"err",value:e,errCtx:t}];if(fe(["if","if!","when","unless","match","satisfy"],o)&&!je(e))return i("provide a condition");if(fe(["if","if!"],o)){if(1===je(e))return i("provide at least one branch");if(je(e)>3)return i(`provide one or two branches, not ${je(e)}`);const t=e.map(n),[r,a]=t;let s=t[2];return s||(s=[{typ:"val",value:Be,errCtx:u}]),[...r,..."if!"===o&&[{typ:"val",value:{t:"func",v:"!"},errCtx:u},{typ:"exe",value:1,errCtx:u}]||[],{typ:"if",value:je(a)+1,errCtx:u},...a,{typ:"jmp",value:je(s),errCtx:u},...s]}if("when"===o||"unless"===o){if(1===je(e))return i("provide a body");const t=e.map(n),[r,a]=[t[0],xe(t,1)],s=qe(a);return[...r,..."unless"===o?[{typ:"val",value:{t:"func",v:"!"}},{typ:"exe",value:1}]:[],{typ:"if",value:je(s)+1,errCtx:u},...s,{typ:"jmp",value:1,errCtx:u},{typ:"val",value:Be,errCtx:u}]}if("match"===o||"satisfy"==o){const t="match"===o?"mat":"sat",r=e.map(n),[a,s]=[r[0],xe(r,1)],c=je(s)%2?s.pop():[];if(!je(s))return i("provide at least one case");const l=je(c);let p=s.reduce(((e,t)=>e+je(t)),0)+(l||2)+je(s);const m=a;for(;je(s)>1;){const[e,r]=[s.shift(),s.shift()];ye(m,e),m.push({typ:t,value:je(r)+1,errCtx:e[0].errCtx}),ye(m,r),p-=je(e)+je(r)+2,m.push({typ:"jmp",value:p,errCtx:u})}return je(c)?ye(m,c):(m.push({typ:"pop",value:1,errCtx:u}),m.push({typ:"val",value:Ie,errCtx:u})),m}if("catch"===o){if(je(e)<2)return i("provide at least 2 arguments");const t=n(e.pop());return[...de(e.map(n)),{typ:"cat",value:je(t),errCtx:u},...t]}if("and"===o||"or"===o||"while"===o){const t=e.map(n);if(je(t)<2)return i("provide at least 2 arguments");const r=[];if("while"===o){const[e,n]=[t[0],xe(t,1)],a=qe(n),s=je(a)+2,c=-(je(e)+je(a)+3);return r.push({typ:"val",value:Be,errCtx:u}),ye(r,e),r.push({typ:"if",value:s,errCtx:u}),r.push({typ:"pop",value:1,errCtx:u}),ye(r,a),r.push({typ:"loo",value:c,errCtx:u}),r}let a=t.reduce(((e,t)=>e+je(t)),0);a+=je(t),a+=Ee("and"===o);const s="and"===o?"if":"or";for(let e=0;e<je(t);++e)ye(r,t[e]),a-=je(t[e]),r.push({typ:s,value:a,errCtx:u}),--a;return"and"===o&&ye(r,[{typ:"val",value:{t:"bool",v:!0},errCtx:u},{typ:"jmp",value:1,errCtx:u}]),r.push({typ:"val",value:Ie,errCtx:u}),r}if("loop"===o){if(je(e)<3)return i("provide at least 3 arguments");const t=e.map(n),r=e[1],a=qe(xe(t,2));return Pe(r)?[{typ:"val",value:{t:"num",v:0},errCtx:u},{typ:"let",value:r.text,errCtx:u},...t[0],{typ:"let",value:r.text+"-limit",errCtx:u},{typ:"pop",value:1,errCtx:u},...a,{typ:"ref",value:r.text,errCtx:u},{typ:"val",value:{t:"func",v:"inc"},errCtx:u},{typ:"exe",value:1,errCtx:u},{typ:"let",value:r.text,errCtx:u},{typ:"ref",value:r.text+"-limit",errCtx:u},{typ:"val",value:{t:"func",v:"<"},errCtx:u},{typ:"exe",value:2,errCtx:u},{typ:"if",value:2,errCtx:u},{typ:"pop",value:1,errCtx:u},{typ:"loo",value:-(je(a)+10),errCtx:u}]:i("argument 2 must be symbol")}if("var"===o||"let"===o){const r=e.filter(((e,t)=>!(t%2))),a=e.filter(((e,t)=>!!(t%2)));if(!je(r))return i("provide at least 1 declaration name and value");if(je(r)>je(a))return i("provide a value after each declaration name");const s=[],c=`${o} name must be a new symbol or destructuring`;for(let e=0,l=je(r);e<l;++e){ye(s,n(a[e]));const l=r[e];if(Pe(l)){const n=He(r[e],t);if(je(n)>1||"ref"!==n[0].typ)return i(c,n[0].errCtx);s.push({typ:o,value:n[0].value,errCtx:u})}else{const{shape:e,errors:t}=Oe([l],!0);if(je(t))return t;if(!je(e))return i(c);const r="var"===o?"dva":"dle";s.push({typ:r,value:e,errCtx:u})}}return s}if("var!"===o||"let!"===o){if(je(e)<2)return i("provide 1 declaration name and 1 function");const t=e.map(n),[r,a,s]=[t[0][0],t[1],xe(t,2)];if("ref"!==r.typ)return i("declaration name must be symbol",r.errCtx);const c=[{typ:"ref",value:r.value,errCtx:u}];ye(c,[...de(s),...a]),c.push({typ:"exe",value:je(s)+1,errCtx:u});const l="var!"===o?"var":"let";return c.push({typ:l,value:r.value,errCtx:u}),c}if("#"===o||"@"===o||"fn"===o){const r=[],n=De([a,...e]),s=[],l=xe(t).map((e=>e.name));let p=!1;if("fn"===o){const n=Oe(e,!1);if(ye(s,n.shape.map((e=>e.name))),ye(t,n.shape),ye(r,n.errors),!je(e))return i("provide a body");p=1===je(e),e.unshift({typ:"sym",text:"do",errCtx:u})}if("@"===o){const t=Me(e,0);if(fe(ae,t)){const{errCtx:r}=e[0];return i(`"${t}" syntax unavailable in partial closure`,r)}e=[{typ:"sym",text:"...",errCtx:u},...e,{typ:"sym",text:"args",errCtx:u}]}ye(r,Ne(e,t,"@"!==o));const m=r.filter((e=>"err"!==e.typ)),v=r.filter((e=>"err"===e.typ));return je(v)?v:(p&&(m.pop(),m.pop()),[{typ:"clo",value:function(e,t,r,n){const a=[],s=[],o=r;for(let e=0,r=c(n);e<r;++e){const c=n[e];let u=!1;if("clo"!==c.typ)"let"===c.typ||"var"===c.typ?o.push(c.value):ve(o,c,e+1!==r&&n[e+1])&&(s.push(c),u=!0),a.push(u);else{a.push(!1);const r=[],o=[];for(let u=0,i=0;u<c.value.length;++u){const l=n[e+1+u],p="npa"===l.typ&&f(t,l.text);a.push(p),o.push(!p&&c.value.captures[u]),p?s.push(c.value.derefs[i++]):c.value.captures[u]&&r.push(c.value.derefs[i++])}c.value.derefs=r,c.value.captures=o,e+=c.value.length}}return{name:e,length:c(n),captures:a,derefs:s}}(n,l,s,m),errCtx:u},...m])}if("->"===o)return Ne(e.reduce(((e,t)=>[t,e])),t);if(ne[o]&&r){const t=oe(o,je(e),u),r=(e,t=u)=>[{typ:"err",value:e,errCtx:t}];ye(s,t?.map((e=>r(e.m)[0]))??[]),t||2===je(e)&&ne[`fast${o}`]&&(s=n({typ:"sym",text:`fast${o}`,errCtx:u}))}}const u=e.map(n),i=de(u);if("return"===Me([a]))return[...i,{typ:"ret",value:!!je(u),errCtx:o}];if(1===je(s)&&"ref"===s[0].typ){const{value:e,errCtx:t}=s[0];s[0]={typ:"val",value:{t:"str",v:e},errCtx:t}}ye(i,s);const l=je(s)>1||fe(["npa","upa"],s[0].typ)?"exa":"exe";return[...i,{typ:l,value:je(u),errCtx:o}]}function Se(e,t){if(Pe(e)){const{errCtx:r}=e;if("str"===e.typ)return[{typ:"val",value:{t:"str",v:e.text},errCtx:r}];if("num"===e.typ)return[{typ:"val",value:{t:"num",v:Ee(e.text)},errCtx:r}];if("sym"===e.typ){const{text:n}=e,a=t.map((({name:e})=>e));if("true"===n||"false"===n)return[{typ:"val",value:{t:"bool",v:"true"===n},errCtx:r}];if("null"===n)return[{typ:"val",value:Be,errCtx:r}];if("_"===n)return[{typ:"val",value:{t:"wild",v:void 0},errCtx:r}];if(Ae(n,":"))return[{typ:"val",value:{t:"key",v:n},errCtx:r}];if("%"===n||Ae(n,"%")&&we(Ce(n,1))){const e="%"===n?0:Ee(Ce(n,1));return e<0?[{typ:"val",value:Be,errCtx:r}]:[{typ:"upa",value:e,text:n,errCtx:r}]}if(fe(a,n)){const e=t.find((({name:e})=>e===n));return 1===je(e.position)?[{typ:"npa",value:e.position[0],text:n,errCtx:r}]:[{typ:"dpa",value:e.position,errCtx:r}]}return"args"===n?[{typ:"upa",value:-1,text:"args",errCtx:r}]:"PI"===n||"E"===n?[{typ:"val",value:{t:"num",v:"PI"===n?3.141592653589793:2.718281828459045},errCtx:r}]:ne[n]?[{typ:"val",value:{t:"func",v:n},errCtx:r}]:[{typ:"ref",value:n,errCtx:r}]}return[]}return je(e)?Ne(e,t):[]}function Oe(e,t,r=[]){const n=[],a=[];let s=0;for(;je(e)>(t?0:1)&&(Pe(e[0])||"vec"===Me(e[0]));){const t=e.shift();if(Pe(t)){const{typ:e,errCtx:c}=t;"sym"===e?n.push({name:t.text,position:[...r,s]}):a.push({typ:"err",value:"provide parameter name",errCtx:c})}else{t.shift();const e=Oe(t,!0,[...r,s]);ye(n,e.shape),ye(a,e.errors)}++s}return{shape:n,errors:a}}function Te({name:e,nodes:t}){const{shape:r,errors:n}=Oe(t,!1),a=[...n,...de(t.map((e=>Se(e,r))))];for(let e=0,t=je(a);e<t;e++){const{typ:t,value:r,errCtx:n}=a[e];if("err"===t)return{e:"Parse",m:r,errCtx:n}}return{name:e,ins:a}}function Fe(e){const t=[];for(let r=0,n=je(e);r<n;++r){const n=e[r];switch(n.typ){case"val":t.push({types:[n.value.t],val:n.value});break;case"exa":case"exe":{const e=t.pop(),r=he(t,je(t)-n.value,n.value),a=e=>r.findIndex((({types:t})=>t&&!e.find((e=>fe(t,e))))),s=t=>e.val?e.val.t===t:e.types&&1===je(e.types)&&e.types[0]===t;if(e.val&&"func"===e.val.t){if("recur"===e.val.v){he(t,je(t)-n.value,n.value);break}const a=ue(e.val.v,r.map((e=>e.types??[])),n.errCtx,!0);if(a)return a;const{returns:s,numeric:c}=ne[e.val.v];t.push(c&&"in only"!==c?{types:["num"]}:{types:s})}else if(s("num")){const e=a(["str","dict","vec"]);if(-1!==e)return le(n.errCtx,r[e].types);t.push({})}else if(s("key")){const e=a(["dict","vec"]);if(-1!==e)return pe(n.errCtx,r[e].types);t.push({})}else s("str")||s("bool")?t.push({}):e.types||e.val||t.push({});break}case"or":t.pop(),t.push({}),r+=n.value;break;case"cat":case"var":case"let":case"dva":case"dle":case"loo":case"jmp":break;case"clo":{const a=Fe(xe(e,r+1,r+n.value.length));if(a)return a;t.push({})}case"ref":case"npa":case"upa":case"dpa":t.push({});break;case"if":{t.pop(),t.push({});const a=Fe(xe(e,r+1,n.value+1));if(a)return a;r+=n.value-1;break}case"mat":case"sat":t.pop(),t.pop(),r+=n.value,r+=e[r].value,t.push({});break;case"pop":he(t,je(t)-n.value,n.value);break;case"ret":n.value&&t.pop()}}}function Re(e,t){const{tokens:r,stringError:n}=function(e,t,r=!0,n=!1){const a=[],s=e=>ge("0123456789",e);let[c,o,u,i]=[!1,1,0,[1,0]],[l,p,m]=[!1,!1,!1];for(let v=0,f=be(e);v<f;++v){const d=ke(e,v),y=v+1!==f?ke(e,v+1):"";if(++u,"\\"===d&&c){a[je(a)-1].text+=r?{n:"\n",t:"\t",r:"\r",'"':'"'}[y]||("\\"===y?"\\":`\\${y}`):`\\${y}`,++u,++v;continue}const x={invokeId:t,line:o,col:u};if('"'===d){(c=!c)&&(i=[o,u],a.push({typ:"str",text:"",errCtx:x})),p=l=!1;continue}const h=ge(" \t\n\r,",d);if(!c&&h){l=!1,p&&(p=","===d),"\n"===d&&(++o,u=0);continue}if(!c&&";"===d){const t=$e(Ce(e,++v),"\n"),r=Ce(e,v,t>0?t:f-v);v+=be(r),++o,u=0,n&&a.push({typ:"rem",text:r,errCtx:x});continue}const b=ge("()[]{}",d);if(p&&!s(d)){const e="x"===d&&"0"===a[je(a)-1].text;m=m||e,p="b"===d&&"0"===a[je(a)-1].text||"."===d&&!ge(a[je(a)-1].text,".")||m&&(e||ge("ABCDEFabcdef",d)),p||b||h||(l=!0,a[je(a)-1].typ="sym")}if(l&&b&&(l=!1),!c&&!l&&!p){if(b){const e=-1===$e("[{(",d)?")":"(";a.push({typ:e,text:r?e:d,errCtx:x}),!r||"["!==d&&"{"!==d||a.push({typ:"sym",text:"["===d?"vec":"dict",errCtx:x});continue}p=s(d)||"."===d&&s(y)||"-"===d&&(s(y)||"."===y),m=l=!p;const e=l?"sym":"num";a.push({typ:e,text:"",errCtx:x})}a[je(a)-1].text+=d}return{tokens:a,stringError:c?i:void 0}}(e,t),a=function(e,t){const r=je(t)?t[0].errCtx.invokeId:"",n=[],a=(e,t)=>n.push({e:"Parse",m:e,errCtx:t});if(e){const[t,s]=e;return a("unmatched double quotation marks",{invokeId:r,line:t,col:s}),n}const s=e=>je(t.filter((({typ:t})=>t===e))),[c,o]=[s("("),s(")")];{const[e,n]=function(e,t,r){const n=r>=t,[a,s]=[n?"(":")",n?")":"("],c=n?1:-1;for(let t=je(e),r=n?0:t-1,o=0;n?r<t:r>=0;r+=c){const{typ:t,errCtx:{line:n,col:c}}=e[r];if(o+=Ee(t===a)-Ee(t===s),o<0)return[n,c]}return[0,0]}(t,c,o);e+n&&a("unmatched parenthesis",{invokeId:r,line:e,col:n})}let u;for(let e=0,r=!1;e<je(t);++e){const n=t[e];if("sym"!==n.typ||"#"!==n.text&&"@"!==n.text){if(r&&")"===n.typ){u=n;break}r="("===n.typ}}return u&&a("empty expression forbidden",u.errCtx),n}(n,r);if(je(a))return{errors:a,funcs:{}};const s=[],c=[],o=function(e){const t=[],r=[];return e.forEach((e=>{if(!Pe(e)&&Pe(e[0])&&"function"===Me(e)){const r=Me(e,1),n=e[0].errCtx;r?je(e)<3?t.push({err:"empty function body",errCtx:n}):ne[r]?t.push({err:"redeclaration of built-in operation",errCtx:n}):t.push({name:r,nodes:xe(e,2)}):t.push({err:"nameless function",errCtx:n})}else r.push(e)})),je(r)&&t.push({name:"entry",nodes:r}),t}(function(e){const t=[],r=e=>{let t;"sym"===e[0].typ&&ge("@#",e[0].text)&&(t=e.shift());const n=e.shift();if("("!==n.typ&&")"!==n.typ)return n;const a=t?[t]:[];for(;")"!==e[0].typ;)a.push(r(e));return e.shift(),a};for(;je(e);)t.push(r(e));return t}(xe(r))),u=[];o.forEach((e=>{"err"in e?c.push({e:"Parse",m:e.err,errCtx:e.errCtx}):u.push({name:e.name,nodes:e.nodes})})),u.map(Te).forEach((e=>{"e"in e?c.push(e):s.push(e)})),ye(c,de(s.map((e=>Fe(e.ins)??[]))));const i={};return s.forEach((e=>i[e.name??""]=e)),{errors:c,funcs:i}}function _e(e,t){return e.dict.has(t)?{kind:"val",value:e.dict.get(t)}:{kind:"err",err:`"${t}" not found.`}}function ze(e,t,r){e.dict.set(t,r)}function Le(e,t,r){switch(t){case"test.function":e.output+=r[0].v+"\n";break;default:return{kind:"err",err:`operation "${t}" does not exist`}}return{kind:"val",value:{t:"null",v:void 0}}}const Ve=[{name:"Hello, world!",code:'"Hello, world!"',out:"Hello, world!"},{name:"Say Hello, world!",code:';This is a test comment\n           (print "Hello, world!")',out:"Hello, world!\nnull"},{name:"1 + 1 = 2",code:"(+ 1 1)",out:"2"},{name:"Negate 1 = -1",code:"(neg 1)",out:"-1"},{name:"(1+1)+1+(1+1) = 5",code:"(+ (+ 1 1) 1 (+ 1 1))",out:"5"},{name:"Conditional head",code:"((if true + -) 12 9 1)",out:"22"},{name:"when and unless",code:'[(when 123 (print "hi") 234) (unless true (print "bye"))]',out:"hi\n[234 null]"},{name:"match and wildcard",code:'(match [1 2]\n             [0 0] (print "hello")\n             [0 2] (print "bye")\n             [1 _] "hey")',out:"hey"},{name:"Cond number head",code:"((if false 1 2) [:a :b :c])",out:":c"},{name:"and & short-circuit",code:'[(and true (if true null 1) (print "hi")) (and 1 2 3)]',out:"[false true]"},{name:"or & short-circuit",code:'[(or true (print "hi") 1) (or false (print-str "-> ") 1)]',out:"-> [true 1]"},{name:"String retrieve",code:'(2 "Hello")',out:"l"},{name:"Vector retrieve",code:"(2 [:a :b :c :d])",out:":c"},{name:"Key as operation",code:'[(:age {:name "Patrick" :age 24}) (:abc [:a :abc :c])]',out:"[24 :abc]"},{name:"Dictionary as op 1",code:'({"name" "Patrick" "age" 24} "age")',out:"24"},{name:"Dictionary as op 2",code:'({"name" "Patrick"} "age" 24)',out:'{"name" "Patrick", "age" 24}'},{name:"Equalities",code:'[(= 1 2 1)\n            (!= 1 2 1)\n            (= "Hello" "hello")\n            (!= "world" "world")\n            (= [0 [1]] [0 [1]])]',out:"[false true false false true]"},{name:"Define and retrieve",code:"(var a 1) a",out:"1"},{name:"Define and add",code:"(var a 1) (inc a)",out:"2"},{name:"Define op and call",code:"(var f +) (f 2 2)",out:"4"},{name:"Define vec and call",code:"(var f [1]) (f 1)",out:"1"},{name:"Define num and call",code:"(var f 1) (f [:a :b :c])",out:":b"},{name:"Apply op to var",code:"(var a 10) (var! a + 10)",out:"20"},{name:"Apply op to let",code:"(let a 10) (let! a (if true + -) (+ 2 3) 5)",out:"20"},{name:"Print simple vector",code:"[1 2 3]",out:"[1 2 3]"},{name:"Boolean select",code:"[(true 1 2) (false 1)]",out:"[1 null]"},{name:"Sum vector of numbers",code:"[(reduce + [1 2 3]) (reduce + 3 [1 2 3])]",out:"[6 9]"},{name:"Sum vectors of numbers",code:"(map + [1 2 3] [1 2 3 4])",out:"[2 4 6]"},{name:"For XY list",code:"(for vec [0 1] [0 1])",out:"[[0 0] [1 0] [0 1] [1 1]]"},{name:"Filter by integer",code:'(filter 2 [[1] [:a :b :c] "hello" "hi"])',out:'[[:a :b :c] "hello"]'},{name:"Comments, short decimal",code:';((print "Hello")\n           .456',out:"0.456"},{name:"Dictionary into vector",code:"(into [1 2] {3 4 5 6})",out:"[1 2 [3 4] [5 6]]"},{name:"Vector into dictionary",code:"(into {[0] 1 [2] 3} [[0] 2])",out:"{[0] 2, [2] 3}"},{name:"While loop",code:"(var n 5)\n           (while (< 0 n)\n             (print-str n)\n             (var n (dec n)))",out:"543210"},{name:"Loop",code:"(loop 3 i (print-str i))",out:"012null"},{name:"Catch error",code:'(catch\n             (:e (catch (let a :a) (+ 1 a) (0 errors)))\n             (print "hi"))',out:"Type"},{name:"Define with no call",code:'(function func (print "Nothing."))'},{name:"Call greet func",code:'(function greeting (print "Hello!")) (greeting)',out:"Hello!\nnull"},{name:"Call const value func",code:"(function const 123) (const)",out:"123"},{name:"Call identity funcs",code:"(function id1 %)\n           (function id2 x x)\n           [(id1 123) (id2 456)]",out:"[123 456]"},{name:"Call greet with name",code:'(function greeting name (print "Hello, " name "!"))\n           (greeting "Patrick")',out:"Hello, Patrick!\nnull"},{name:"Call with too few args",code:"(function func a b c [a b c]) (func 1 2)",out:"[1 2 null]"},{name:"Define func and call",code:"(function func a b (+ a b)) (var f func) (f 2 2)",out:"4"},{name:"Anonymous parameters",code:"(function avg<n? (< (/ (.. + %) (len %)) %1))\n           (avg<n? [0 10 20 30 40] 5)",out:"false"},{name:"Call parameter",code:'(function f x (x "hello")) (f print)',out:"hello\nnull"},{name:"Let and retrieve",code:"(function f (let a 1) a) (f)",out:"1"},{name:"Let num op and call",code:"(function f (let n 0) (n [1])) (f)",out:"1"},{name:"Explicit return",code:"(function f (return 123) (print 456)) (f)",out:"123"},{name:"Closure 1",code:"(let x 10)\n           (let closure #(+ x x))\n           (let x 11)\n           (closure)",out:"20"},{name:"Closure 2",code:"(filter #(or (.. = args) (even? %)) (range 10) 5)",out:"[0 2 4 5 6 8]"},{name:"Closure 3",code:"(function f #(+ x x))\n           (var x 10) (let c20 (f))\n           (var x 20) (let c40 (f))\n           [(c20) (c40)]",out:"[20 40]"},{name:"Closure with ext func",code:"(#(test.function %) 1)",out:"1\nnull"},{name:"Func returns closure",code:"(function f x #(x 2 2))\n           (let closure (f +))\n           (closure)",out:"4"},{name:"Dictionary closure",code:"(function f x #{x 2})\n           (let closure (f :a))\n           (closure)",out:"{:a 2}"},{name:"Vector closure",code:"(function f x #[1 x %])\n           (let closure (f 2))\n           (closure 3)",out:"[1 2 3]"},{name:"Closure as head",code:"(#[% %1 %2] 1 2 3)",out:"[1 2 3]"},{name:"Partial closure 1",code:"(@[] 1 2 3)",out:"[1 2 3]"},{name:"Partial closure 2",code:"(@((do +) 2) 2)",out:"4"},{name:"Parameterised closure 1",code:"((fn a b (+ a b)) 2 2)",out:"4"},{name:"Parameterised closure 2",code:"((fn a b (print-str a b) (+ a b)) 2 2)",out:"224"},{name:"Parameterised closure 3",code:"(reduce\n             (fn primes num\n               (if (find zero? (map (rem num) primes))\n                 primes\n                 (append num primes)))\n             [2]\n             (range 3 10))",out:"[2 3 5 7]"},{name:"Closure with inter-lets",code:"(let a + c 5 d 10)\n           (let closure (fn b (let d 1) (a b c d)))\n           (let a - c 4 d 11)\n           (closure 1)",out:"7"},{name:"Closure with inner-let",code:"(((fn x (let y 1) #[x y]) 2))",out:"[2 1]"},{name:"Closure with captured f",code:"[((fn x (@(val x))) 0) (var f val) ((fn y (@(f y))) 0)]",out:"[0 val 0]"},{name:"Closure w/ inter-params",code:"(function f x (fn y (fn z [x y z]))) (((f :a) :b) :c)",out:"[:a :b :c]"},{name:"Destructure var",code:"(var [x [y]] [1 [2]]) [y x]",out:"[2 1]"},{name:"Destructure string",code:'(let [a b c] "hello") [a b c]',out:'["h" "e" "l"]'},{name:"Destructure function",code:"(function f a [[b c] d] e [e d c b a]) (f 0 [[1 2] 3] 4)",out:"[4 3 2 1 0]"},{name:"Destructuring closure",code:"(let f (fn a [b [c]] d [d c b a])) (f 0 [1 [2]] 3)",out:"[3 2 1 0]"},{name:"Destructuring fn decoy",code:"(let f (fn a [a [a]])) (f 0)",out:"[0 [0]]"},{name:"Implicit currying",code:"(-> 1 inc (+ 10))",out:"12"},{name:"String instead of number",code:'(function sum (.. + args))\n           (print (sum 2 2))\n           (sum 2 "hi")',out:"4",err:["Type"]},{name:"Reference non-existing",code:"x",err:["Reference"]},{name:"Expired let retrieve",code:"(function f (let a 1) a) (f) a",err:["Reference"]},{name:"Call non-existing",code:"(x)",err:["External"]},{name:"Call budget",code:"(function f (f)) (f)",err:["Budget"]},{name:"Loop budget",code:"(var n 10000)\n           (while (< 0 n)\n             (var n (dec n)))",err:["Budget"]},{name:"Range budget",code:"(range 10000)",err:["Budget"]},{name:"Head exe arity check",code:"(((fn +)) 1)",err:["Arity"]},{name:"Fibonacci 13",code:"(function fib n\n             (if (< n 2) n\n               (+ (fib (dec n))\n                  (fib (- n 2)))))\n           (fib 13)",out:"233"},{name:"dedupe (recur)",code:"(function dedupe list -out\n             (let out (or -out []))\n             (let next (if (out (0 list)) [] [(0 list)]))\n             (if (empty? list) out\n                 (recur (sect list) (into out next))))\n           (dedupe [1 1 2 3 3 3])",out:"[1 2 3]"},{name:"frequencies",code:'(function frequencies list\n             (reduce #(% %1 (inc (or (% %1) 0))) {} list))\n           (frequencies "12121212")',out:'{"1" 4, "2" 4}'},{name:"set get",code:"[($globals.time_offset 5.5) $globals.time_offset]",out:"[5.5 5.5]"},{name:"exe",code:"(test.function 123)",out:"123\nnull"},{name:"Empty parens",code:"()",err:["Parse"]},{name:"Imbalanced parens 1",code:'(print ("hello!")',err:["Parse"]},{name:"Imbalanced parens 2",code:'print "hello!")',err:["Parse"]},{name:"Imbalanced quotes",code:'(print "Hello)',err:["Parse"]},{name:"Function as op",code:"(function)",err:["Parse"]},{name:"Function without name",code:"(function (+))",err:["Parse"]},{name:"Function without body",code:"(function func)",err:["Parse"]},{name:"Variable not symbol",code:"(var 1 2)",err:["Parse"]},{name:"Parser type error 1",code:"(function f (+ 1 :a))",err:["Type"]},{name:"Parser type error 2",code:"(function f (+ 1 (into {} {})))",err:["Type"]},{name:"Parser type error 3",code:"(function f (if true (into 2 {}) (+ 2 2)))",err:["Type"]},{name:"Parser arity error 1",code:"(abs)",err:["Parse"]}],Ke=({v:e})=>e,We=({v:e})=>e,Ue=({v:e})=>e,Xe=({v:e})=>e,Ye=e=>({t:"bool",v:e}),Ge=e=>({t:"num",v:e}),Je=(e="")=>({t:"str",v:e}),Qe=e=>({t:"key",v:e}),Ze=(e=[])=>({t:"vec",v:e}),et=e=>({t:"dict",v:e}),tt=e=>({t:"func",v:e}),rt=(e,t)=>c(e)===c(t)&&!e.some(((e,r)=>!nt(e,t[r]))),nt=(e,t)=>{if("wild"===e.t||"wild"===t.t)return!0;if(e.t!==t.t)return!1;switch(e.t){case"null":return!0;case"bool":case"num":return e.v===t.v;case"vec":return rt(e.v,Ue(t));case"dict":{const r=Xe(t);return c(e.v.keys)===c(r.keys)&&rt(e.v.keys,r.keys)}case"str":case"ref":case"key":case"func":return We(e)===We(t);case"clo":return e.v.name===t.v.name;case"ext":return e.v===t.v}return 0},at=e=>e.reduce(((e,t)=>e+st(t)),""),st=e=>{const t=e=>{return"str"===e.t?`"${t=e.v,t.split("").map((e=>'"'===e?'\\"':e)).join("")}"`:st(e);var t};if("clo"===e.t)return e.v.name??"";if("vec"===e.t)return`[${e.v.map(t).join(" ")}]`;if("dict"===e.t){const{keys:r,vals:n}=e.v,[a,s]=[r.map(t),n.map(t)];return`{${a.map(((e,t)=>`${e} ${s[t]}`)).join(", ")}}`}return"null"===e.t?"null":"wild"===e.t?"_":`${e.v}`},ct=e=>"vec"===e.t?a(e.v):"str"===e.t?[...e.v].map((e=>({t:"str",v:e}))):"dict"===e.t?e.v.keys.map(((t,r)=>({t:"vec",v:[t,e.v.vals[r]]}))):[],ot=e=>{c(e)%2==1&&e.pop();const t=e.filter(((e,t)=>t%2==0)),r=e.filter(((e,t)=>t%2==1)),n=[],a=[];return t.forEach(((e,t)=>{const s=n.findIndex((t=>nt(t,e)));-1===s?(n.push(e),a.push(r[t])):a[s]=r[t]})),{t:"dict",v:{keys:n,vals:a}}},ut=({keys:e,vals:t},r)=>{const n=e.findIndex((e=>nt(e,r)));return-1===n?{t:"null",v:void 0}:t[n]},it=({keys:e,vals:t},r,n)=>{const[s,c]=[a(e),a(t)],o=e.findIndex((e=>nt(e,r)));return-1!==o?c[o]=n:(s.push(r),c.push(n)),{keys:s,vals:c}};function lt(e,t,r){if(!c(e)||"vec"!==r.t&&"dict"!==r.t||"vec"===r.t&&("num"!==e[0].t||e[0].v<0||e[0].v>c(r.v)))return r;if("vec"===r.t){const n=a(r.v),s=Ke(e[0]);return 1===c(e)?(n[s]=t(n[s]),{t:"vec",v:n}):(n[s]=lt(a(e,1),t,n[s]),{t:"vec",v:n})}if(1===c(e)){const n=ut(r.v,e[0]);return{t:"dict",v:it(r.v,e[0],t(n))}}return{t:"dict",v:it(r.v,e[0],lt(a(e,1),t,ut(r.v,e[0])))}}const{abs:pt,sign:mt,sqrt:vt,floor:ft,ceil:dt,round:yt,max:xt,min:ht,logn:bt,log2:At,log10:gt}=r,{cos:Ct,sin:kt,tan:$t,acos:wt,asin:jt,atan:Et,sinh:Bt,cosh:It,tanh:Pt}=r,{concat:Mt,has:Dt,flat:qt,push:Ht,reverse:Nt,slice:St,splice:Ot,sortBy:Tt}=r,{ends:Ft,slen:Rt,starts:_t,sub:zt,subIdx:Lt,substr:Vt,upperCase:Kt,lowerCase:Wt}=r,{trim:Ut,trimStart:Xt,trimEnd:Yt,strIdx:Gt,replace:Jt,rreplace:Qt}=r,{charCode:Zt,codeChar:er,getTimeMs:tr,randInt:rr,randNum:nr}=r,{isNum:ar,len:sr,objKeys:cr,range:or,toNum:ur,isArray:ir}=r;let lr,pr=[],mr={};function vr(e){throw{errors:e}}function fr(e){return!!e&&"object"==typeof e&&"errors"in e}const dr=(e,t)=>vr([ie(e,t)]);const yr=(e,t)=>[{e:"Arity",m:`${se[e]} as operation requires one sole argument`,errCtx:t}];function xr(e,t,r,n){if(n){const n=oe(e,sr(t),r);if(n)return n}return ue(e,t.map((e=>[e.t])),r)||!1}function hr(e,t,r,n=!0){if("str"===t.t||"func"===t.t){const o=t.v;return ne[o]?ne[o].external?t=>{const a=xr(o,t,r,n);a&&vr(a);const s=e.functions[o].handler(t);return"err"===s.kind?vr([{e:"External",m:s.err,errCtx:r}]):s.value}:t=>{const n=xr(o,t,r,!0);return n&&vr(n),function(e,t,r,n){switch(e){case"str":return Je(at(t));case"strn":return Je(at(t.filter((e=>"null"!==e.t))));case"print":case"print-str":return r.print(at(t),"print"===e),{t:"null",v:void 0};case"vec":return Ze(t);case"dict":return ot(t);case"len":return Ge("str"===t[0].t?Rt(t[0].v):"vec"===t[0].t?sr(t[0].v):sr(Xe(t[0]).keys));case"to-num":return ar(t[0].v)?Ge(ur(t[0].v)):{t:"null",v:void 0};case"to-key":return Qe(`:${st(t[0])}`);case"to-vec":return Ze(ct(t[0]));case"!":return Ye(!ce(t[0]));case"=":case"!=":for(let r=1,n=sr(t);r<n;++r)if(nt(t[r-1],t[r])!==("="===e))return Ye(!1);return Ye(!0);case"-":return Ge(t.map(Ke).reduce(((e,t)=>e-t)));case"**":return Ge(Ke(t[0])**(1===sr(t)?2:Ke(t[1])));case"+":return Ge(t.map(Ke).reduce(((e,t)=>e+t)));case"*":return Ge(t.map(Ke).reduce(((e,t)=>e*t)));case"/":return Ge(t.map(Ke).reduce(((e,t)=>e/t)));case"//":return Ge(t.map(Ke).reduce(((e,t)=>ft(e/t))));case"fast=":case"fast!=":return Ye(nt(t[0],t[1])===("fast="===e));case"fast-":return Ge(t[0].v-t[1].v);case"fast+":return Ge(t[0].v+t[1].v);case"fast*":return Ge(t[0].v*t[1].v);case"fast/":return Ge(t[0].v/t[1].v);case"fast//":return Ge(ft(t[0].v/t[1].v));case"fast<":return Ye(t[0].v<t[1].v);case"fast>":return Ye(t[0].v>t[1].v);case"fast<=":return Ye(t[0].v<=t[1].v);case"fast>=":return Ye(t[0].v>=t[1].v);case"neg":return Ge(-Ke(t[0]));case"rem":return Ge(t.map(Ke).reduce(((e,t)=>e%t)));case"min":return Ge(t.map(Ke).reduce(((e,t)=>ht(e,t))));case"max":return Ge(t.map(Ke).reduce(((e,t)=>xt(e,t))));case"<":case">":case"<=":case">=":for(let r=1,n=sr(t);r<n;++r){const[n,a]=[t[r-1].v,t[r].v];if("<"===e&&n>=a||">"===e&&n<=a||"<="===e&&n>a||">="===e&&n<a)return Ye(!1)}return Ye(!0);case"str<":case"str>":case"str<=":case"str>=":t.some((({t:e})=>"str"!==e))&&dr("can only compare all string",n);for(let r=1,n=sr(t);r<n;++r){const[n,a]=[t[r-1].v,t[r].v];if("str<"===e&&n>=a||"str>"===e&&n<=a||"str<="===e&&n>a||"str>="===e&&n<a)return Ye(!1)}return Ye(!0);case"inc":return Ge(t[0].v+1);case"dec":return Ge(t[0].v-1);case"abs":return Ge(pt(t[0].v));case"round":if(2===sr(t)){const e=10**t[0].v;return Ge(yt(t[1].v*e)/e)}return Ge(yt(t[0].v));case"sin":case"cos":case"tan":case"sqrt":case"floor":case"ceil":case"logn":case"log2":case"log10":return Ge((0,{sin:kt,cos:Ct,tan:$t,sqrt:vt,floor:ft,ceil:dt,logn:bt,log2:At,log10:gt}[e])(Ke(t[0])));case"asin":case"acos":case"atan":case"sinh":case"cosh":case"tanh":return Ge((0,{asin:jt,acos:wt,atan:Et,sinh:Bt,cosh:It,tanh:Pt}[e])(Ke(t[0])));case"and":return Ye(t.every(ce));case"or":{const e=t.findIndex(ce);return-1===e?{t:"null",v:void 0}:t[e]}case"xor":return ce(t[0])!==ce(t[1])?ce(t[0])?t[0]:t[1]:Ye(!1);case"&":case"|":case"^":case"<<":case">>":case">>>":const[o,u]=[Ke(t[0]),Ke(t[1])];return Ge("&"===e?o&u:"|"===e?o|u:"^"===e?o^u:"<<"===e?o<<u:">>"===e?o>>u:o>>>u);case"~":return Ge(~Ke(t[0]));case"odd?":case"even?":return Ye(Ke(t[0])%2==("odd?"===e?1:0));case"pos?":case"neg?":case"zero?":{const r=Ke(t[0]);return Ye("pos?"===e?r>0:"neg?"===e?r<0:!r)}case"null?":case"num?":case"bool?":case"str?":case"dict?":case"vec?":case"key?":case"func?":case"wild?":case"ext?":{const{t:r}=t[0];return Ye("func?"===e&&("func"===r||"clo"===r)||Vt(e,0,Rt(e)-1)===r)}case"type-of":return Je(t[0].t);case"substr?":return Ye(!!Rt(We(t[0]))&&zt(We(t[1]),We(t[0])));case"idx":{let e=-1;return"str"===t[1].t?"str"!==t[0].t?dr("strings can only contain strings",n):e=Lt(t[0].v,t[1].v):"vec"===t[1].t&&(e=t[1].v.findIndex((e=>nt(e,t[0])))),-1===e?{t:"null",v:void 0}:Ge(e)}case"set-at":{const[e,r,n]=t;return lt(Ue(e),(e=>r),n)}case"update-at":{const[e,a,s]=t,c=hr(r,a,n);return lt(Ue(e),(e=>c([e])),s)}case"juxt":{const e=e=>[{typ:"val",value:e,errCtx:n},{typ:"upa",value:-1,text:"args",errCtx:n},{typ:"val",value:tt("..."),errCtx:n},{typ:"exe",value:2,errCtx:n}],r=[...qt(t.map(e)),{typ:"val",value:tt("vec"),errCtx:n},{typ:"exe",value:sr(t),errCtx:n}];return{t:"clo",v:{name:`(juxt ${t.map(st).join(" ")})`,ins:r}}}case"pos-juxt":{const e=(e,t)=>[{typ:"dpa",value:[0,t],errCtx:n},{typ:"val",value:e,errCtx:n},{typ:"exe",value:1,errCtx:n}],r=[...qt(t.map(e)),{typ:"val",value:tt("vec"),errCtx:n},{typ:"exe",value:sr(t),errCtx:n}];return{t:"clo",v:{name:`(pos-juxt ${t.map(st).join(" ")})`,ins:r}}}case"map":case"for":case"reduce":case"reductions":case"filter":case"remove":case"find":case"count":{const a=hr(r,t.shift(),n);if("map"===e||"for"===e){const e=t.findIndex((({t:e})=>"vec"!==e&&"str"!==e&&"dict"!==e));if(-1!==e){const r=se[t[e].t];dr(`argument ${e+2} must be either: string, vector, dictionary, not ${r}`,n)}}if("for"===e){const e=t.map(ct),s=e.map(sr),c=s.map(((e,t)=>St(s,0,t+1).reduce(((e,t)=>e*t))));c.unshift(1);const o=c.pop();o>r.loopBudget&&vr([{e:"Budget",m:"would exceed loop budget",errCtx:n}]);const u=[];for(let t=0;t<o;++t){const r=c.map(((e,r)=>ft(t/e%s[r])));u.push(a(e.map(((e,t)=>e[r[t]]))))}return Ze(u)}if("map"===e){const e=t.map(ct),r=ht(...e.map(sr)),n=[];for(let t=0;t<r;++t)n.push(a(e.map((e=>e[t]))));return Ze(n)}if("reduce"!==e&&"reductions"!=e){const r=t.shift(),n=ct(r),s="remove"===e,c="find"===e,o="count"===e,u=[];let i=0;for(let e=0,r=sr(n);e<r;++e){const r=ce(a([n[e],...t]));if(o)i+=r?1:0;else if(c){if(r)return n[e]}else r!==s&&u.push(n[e])}switch(e){case"count":return Ge(i);case"find":return{t:"null",v:void 0}}return"str"===r.t?Je(u.map((e=>st(e))).join("")):"dict"===r.t?ot(qt(u.map((e=>e.v)))):Ze(u)}const s=t.pop();Dt(["vec","dict","str"],s.t)||dr(`must reduce either: string, vector, dictionary, not ${se[s.t]}`,n);const c=ct(s);if(!sr(c))return sr(t)?t[0]:Ze();if(sr(c)<2&&!sr(t))return c[0];let o=(sr(t)?t:c).shift();if("reductions"===e){const e=[];for(let t=0,r=sr(c);t<r;++t)e.push(o),o=a([o,c[t]]);return e.push(o),Ze(e)}for(let e=0,t=sr(c);e<t;++e)o=a([o,c[e]]);return o}case"repeat":case"times":{const a=t["repeat"===e?0:1],s=[],c=Ke(t["repeat"===e?1:0]);if(c>r.rangeBudget&&vr([{e:"Budget",m:"would exceed range budget",errCtx:n}]),r.rangeBudget-=c,"func"===a.t||"clo"===a.t){const e=hr(r,a,n);for(let t=0;t<c;++t)s.push(e([Ge(t)]))}else for(let e=0;e<c;++e)s.push(a);return Ze(s)}case"rand-int":case"rand":{const r=sr(t),[n,a]=[r<2?0:Ke(t[0]),0===r?1+ur("rand-int"===e):Ke(1===r?t[0]:t[1])];return Ge("rand-int"===e?rr(n,a):nr(n,a))}case"do":case"val":return"do"===e?t.pop():t.shift();case".":case"..":case"...":{const a=hr(r,t.shift(),n);if("."===e)return a(t);let s=t;if(".."===e)s=qt(t.map((e=>"vec"===e.t?e.v:[e])));else{const e=s.pop();Ht(s,qt(["vec"===e.t?e.v:[e]]))}return a(s)}case"into":if("vec"===t[0].t)return Ze(Mt(t[0].v,ct(t[1])));if("vec"===t[1].t)return ot(Mt(qt(ct(t[0]).map(Ue)),t[1].v));{const{keys:e,vals:r}=Xe(t[0]),{keys:n,vals:a}=Xe(t[1]);return et({keys:Mt(e,n),vals:Mt(r,a)})}case"omit":return(({keys:e,vals:t},r)=>{const[n,c]=[a(e),a(t)],o=e.findIndex((e=>nt(e,r)));return-1!==o&&(s(n,o,1),s(c,o,1)),{t:"dict",v:{keys:n,vals:c}}})(Xe(t[1]),t[0]);case"drop":{const[e,r]=[Ke(t[0]),Ue(t[1])];return Ze(Mt(St(r,0,e),St(r,e+1)))}case"assoc":return et(it(Xe(t[2]),t[0],t[1]));case"append":return Ze(Mt(Ue(t[1]),[t[0]]));case"prepend":return Ze(Mt([t[0]],Ue(t[1])));case"insert":{const e=Ue(t[2]);let r=Ke(t[1]);return 0===r?Ze(Mt([t[0]],e)):-1===r?Ze(Mt(e,[t[0]])):(r=r>0?ht(r,sr(e)):xt(sr(e)+1+r,0),Ze(Mt(Mt(St(e,0,r),[t[0]]),St(e,r))))}case"sect":{const e=t[0],r="vec"===e.t?sr(e.v):Rt(We(e));let n=0,a=r;switch(sr(t)){case 1:n=1;break;case 2:{const e=Ke(t[1]);e<0?a+=e:n+=e;break}case 3:{const e=Ke(t[1]),s=Ke(t[2]);n=e<0?r+e+(s<0?s:0):n+e,a=(s<0?a:n)+s;break}}return n=xt(n,0),a=ht(a,r),n>a?("vec"===e.t?Ze:Je)():"vec"===e.t?Ze(St(e.v,n,a)):Je(Vt(We(t[0]),n,a-n))}case"skip":case"first":case"last":case"crop":{const r=xt(0,Ke(t[0])),{t:n,v:a}=t["crop"===e?2:1],s="str"===n?Rt(a):sr(a);let c="first"===e?0:"last"===e?s-r:r;const o="first"===e?r:"crop"===e?s-xt(0,Ke(t[1])):s;return c=c>o?o:c,"str"===n?Je(Vt(a,c,o-c)):Ze(St(a,c,o))}case"reverse":return"str"===t[0].t?Je(at(Nt(ct(t[0])))):Ze(Nt(ct(t[0])));case"flatten":{const e=Ue(t[0]),r=[],n=e=>e.forEach((e=>"vec"===e.t?n(e.v):r.push(e)));return n(e),Ze(r)}case"shuffle":{const e=St(Ue(t[0]));for(let t=sr(e)-1;t;--t){const r=ft(rr(0,t+1));[e[t],e[r]]=[e[r],e[t]]}return Ze(e)}case"sample":{const e=St(Ue(t[1])),r=xt(0,ht(sr(e),Ke(t[0]))),n=sr(e)-r;for(let t=sr(e)-1;t>n;--t){const r=ft(rr(0,t+1));[e[t],e[r]]=[e[r],e[t]]}return Ze(St(e,n))}case"sort":case"sort-by":{const a=ct(t["sort"===e?0:1]);if(!sr(a))return Ze();const s=[];if("sort"===e)Ht(s,a.map((e=>[e,e])));else{const e=hr(r,t[0],n);for(let t=0,r=sr(a);t<r;++t)s.push([a[t],e([a[t]])])}const c=s[0][1].t;return s.some((([e,{t}])=>t!==c||!Dt(["num","str"],t)))&&dr("can only sort by all number or all string",n),Tt(s,"num"===c?([e,t],[r,n])=>Ke(t)>Ke(n)?1:-1:([e,t],[r,n])=>We(t)>We(n)?1:-1),Ze(s.map((([e])=>e)))}case"group-by":{const e=hr(r,t[0],n),a={keys:[],vals:[]};if("dict"===t[1].t){const{keys:r,vals:n}=Xe(t[1]);for(let t=0,s=sr(r);t<s;++t){const s=e([r[t],n[t]]),c=a.keys.findIndex((e=>nt(e,s)));if(-1===c)a.keys.push(s),a.vals.push(et({keys:[r[t]],vals:[n[t]]}));else{const e=Xe(a.vals[c]);e.keys.push(r[t]),e.vals.push(n[t])}}}else{const r=ct(t[1]);for(let t=0,n=sr(r);t<n;++t){const n=e([r[t]]),s=a.keys.findIndex((e=>nt(e,n)));-1===s?(a.keys.push(n),a.vals.push(Ze([r[t]]))):Ue(a.vals[s]).push(r[t])}}return et(a)}case"part-by":{const e=hr(r,t[0],n);if("dict"===t[1].t){const{keys:r,vals:n}=Xe(t[1]),a=[{keys:[],vals:[]},{keys:[],vals:[]}];for(let t=0,s=sr(r);t<s;++t){const s=ce(e([r[t],n[t]]))?0:1;a[s].keys.push(r[t]),a[s].vals.push(n[t])}return Ze(a.map(et))}{const r=ct(t[1]),n=[[],[]];for(let t=0,a=sr(r);t<a;++t)n[ce(e([r[t]]))?0:1].push(r[t]);return Ze(n.map(Ze))}}case"freqs":{const e=ct(t[0]),r=[],n=[];return e.forEach((e=>{const t=r.findIndex((t=>nt(e,t)));-1!==t?++n[t]:(r.push(e),n.push(1))})),et({keys:r,vals:n.map(Ge)})}case"distinct":{const e=1===sr(t)&&"vec"===t[0].t?Ue(t[0]):t,r=[];return e.forEach((e=>{r.some((t=>nt(e,t)))||r.push(e)})),Ze(r)}case"range":{const[e,a,s]=t.map(Ke),c=s&&s<0&&e<a,[o,u]=sr(t)>1?c?[a-1,e-1]:[e,a]:[0,e],i=mt((u-o)*(s||1))*(s||1),l=dt(pt((u-o)/i));if(!l)return Ze();l>r.rangeBudget&&vr([{e:"Budget",m:"would exceed range budget",errCtx:n}]),r.rangeBudget-=l;const p=or(l).map((e=>e*i+o));return Ze(p.map(Ge))}case"empty?":return Ye(!sr(ct(t[0])));case"keys":case"vals":return Ze(Xe(t[0])["keys"===e?"keys":"vals"]);case"split":return Ze(We(t[1]).split(We(t[0])).map(Je));case"join":return Je(ct(t[1]).map(st).join(We(t[0])));case"replace":case"rreplace":return Je(("replace"===e?Jt:Qt)(We(t[2]),We(t[0]),We(t[1])));case"starts?":case"ends?":return Ye(("starts?"===e?_t:Ft)(We(t[1]),We(t[0])));case"upper-case":case"lower-case":case"trim":case"trim-start":case"trim-end":return Je(("upper-case"===e?Kt:"lower-case"===e?Wt:"trim"===e?Ut:"trim-start"===e?Xt:Yt)(We(t[0])));case"str*":{const e=We(t[0]);return Je(or(xt(dt(Ke(t[1])),0)).map((t=>e)).join(""))}case"char-code":if("str"===t[0].t){const e=sr(t)>1?Ke(t[1]):0,r=We(t[0]);return Rt(r)<=e||e<0?{t:"null",v:void 0}:Ge(Zt(Gt(r,e)))}return Je(er(Ke(t[0])));case"time":return Ge(tr());case"version":return Ge(220417);case"tests":return Je(function(e,t=!0){const r=[];for(let t=0;t<c(Ve);++t){const{name:n,code:a,err:s,out:c}=Ve[t],o={dict:new Map,output:""},u={funcs:{},vars:{}},i=S(),l=e({get:e=>_e(o,e),set:(e,t)=>ze(o,e,t),print:(e,t)=>{o.output+=e+(t?"\n":"")},exe:(e,t)=>Le(o,e,t),functions:{},env:u,loopBudget:1e4,rangeBudget:1e3,callBudget:1e3,recurBudget:1e4},a,a,!0),p="errors"===l.kind?l.errors:[],m=(s||[]).join()===p.map((({e})=>e)).join(),v=!c||j(o.output)===c,f=S()-i,[d,y,x,h,b]=[I(`${t+1}`,3),I(n,24),I(`${G(f)}ms`,6),v||c+"\t!=\t"+j(o.output),m||p.map((({e,m:t,errCtx:{line:r,col:n}})=>`${e} ${r}:${n}: ${t}`))];r.push({okErr:m,okOut:v,elapsedMs:f,display:`${d} ${y} ${x} ${h} ${b}`})}const n=r.reduce(((e,{elapsedMs:t})=>e+t),0),a=c(r.filter((({okOut:e,okErr:t})=>e&&t)));return A(r.filter((e=>!t||!e.okOut||!e.okErr)).map((e=>e.display)),[`---- ${a}/${c(r)} tests passed in ${G(n)}ms.`])}(kr,!(sr(t)&&ce(t[0]))).join("\n"));case"symbols":return Ze(function(e,t=!0){let r=[];t&&Ht(r,ae),Ht(r,["args","PI","E"]),r=Mt(r,cr(ne)),r=Mt(r,cr(e.funcs)),r=Mt(r,cr(e.vars));const n=["entry"];return r=r.filter((e=>!Dt(n,e))),Tt(r,((e,t)=>e>t?1:-1))}(r.env,!1).map((e=>(ne[e]?tt:Je)(e))));case"eval":{delete r.env.funcs.entry;const e=`${n.invokeId} eval`;try{return Cr(r,We(t[0]),e,[])||{t:"null",v:void 0}}catch(e){fr(e)&&vr([{e:"Eval",m:"error within evaluated code",errCtx:n},...e.errors])}}case"about":{const e=We(t[0]),r=ne[e];if(!r)return{t:"null",v:void 0};const n=[],a=(e,t)=>n.push(Qe(`:${e}`),t),s=e=>Ze(e.map((e=>ir(e)?Ze(e.map(Je)):Je(e))));return a("external?",Ye(!!r.external)),r.exactArity?a("exact-arity",Ge(r.exactArity)):(r.minArity&&a("minimum-arity",Ge(r.minArity)),r.maxArity&&a("maximum-arity",Ge(r.maxArity))),(r.params||r.numeric)&&a("in-types",s(r.params?r.params:["num"])),(r.returns||!0===r.numeric)&&a("out-types",s(r.returns?r.returns:["num"])),ot(n)}case"recur":return lr=t,{t:"null",v:void 0};case"reset":return r.env.vars={},r.env.funcs={},pr=[],{t:"null",v:void 0}}return vr([{e:"Unexpected",m:"operation doesn't exist",errCtx:n}])}(o,t,e,r)}:o in e.env.funcs&&"entry"!==o?t=>gr(e,e.env.funcs[o],t):o in e.env.vars?hr(e,e.env.vars[o],r):o in mr?hr(e,mr[o],r):_t(o,"$")?n=>{if(sr(n)||vr(yr(t.t,r)),!e.set)return vr([{e:"External",m:'"set" feature not implemented on this platform',errCtx:r}]);const a=e.set(Vt(o,1),n[0]);return a&&vr([{e:"External",m:a,errCtx:r}]),n[0]}:t=>{if(!e.exe)return vr([{e:"External",m:`operation "${o}" does not exist"`,errCtx:r}]);const n=e.exe(o,t);return"val"===n.kind?n.value:vr([{e:"External",m:n.err,errCtx:r}])}}if("clo"===t.t)return r=>gr(e,t.v,r);if("key"===t.t)return e=>(sr(e)||vr(yr(t.t,r)),"dict"===e[0].t?ut(Xe(e[0]),t):"vec"===e[0].t?Ue(e[0]).find((e=>nt(e,t)))??{t:"null",v:void 0}:vr(pe(r,[e[0].t])));if("num"===t.t){const e=ft(t.v);return n=>{sr(n)||vr(yr(t.t,r));const a=n[0];if("str"!==a.t&&"vec"!==a.t&&"dict"!==a.t)return vr(le(r,[a.t]));const s=ct(a),c=sr(s);return e>=0&&e>=c||e<0&&-e>c?{t:"null",v:void 0}:e<0?s[c+e]:s[e]}}if("vec"===t.t){const{v:e}=t;return n=>(sr(n)||vr(yr(t.t,r)),e.find((e=>nt(e,n[0])))??{t:"null",v:void 0})}if("dict"===t.t){const e=t.v;return t=>1===sr(t)?ut(e,t[0]):2===sr(t)?et(it(e,t[0],t[1])):vr([{e:"Arity",m:"provide 1 or 2 arguments for dictionary",errCtx:r}])}if("bool"===t.t){const e=t.v;return t=>!sr(t)||sr(t)>2?vr([{e:"Arity",m:"provide 1 or 2 arguments for boolean",errCtx:r}]):e?t[0]:sr(t)>1?t[1]:{t:"null",v:void 0}}return e=>vr([{e:"Operation",m:`${st(t)} is an invalid operation`,errCtx:r}])}function br(e){const t=(e,t,r)=>it(e,Qe(t),r);return e.map((({e,m:r,errCtx:n})=>{let a=t({keys:[],vals:[]},":e",Je(e));return a=t(a,":m",Je(r)),a=t(a,":line",Ge(n.line)),a=t(a,":col",Ge(n.col)),et(a)}))}function Ar(e,t){let r=e;for(let e=0,n=sr(t)-1;e<n;++e){const a=r[t[e]];if("vec"!==a.t)return"str"===a.t&&e+1===n&&t[e+1]<Rt(a.v)?Je(Gt(a.v,t[e+1])):{t:"null",v:void 0};r=a.v}const n=t[sr(t)-1];return n>=sr(r)?{t:"null",v:void 0}:r[n]}function gr(e,t,r,n=!1){--e.callBudget,n||(pr.push({}),mr=pr[sr(pr)-1]);const a=[];for(let n=0,s=sr(t.ins);n<s;++n){const c=t.ins[n],{errCtx:o}=t.ins[n],u=e.loopBudget<1;switch((u||e.callBudget<1)&&vr([{e:"Budget",m:(u?"looped":"called")+" too many times",errCtx:o}]),c.typ){case"val":a.push(c.value);break;case"var":e.env.vars[c.value]=a[sr(a)-1];break;case"let":mr[c.value]=a[sr(a)-1];break;case"dle":case"dva":{const t=a.pop();let r;c.value.forEach((({name:n,position:a})=>{r="dva"===c.typ?e.env.vars[n]=Ar([t],a):mr[n]=Ar([t],a)})),a.push(r);break}case"npa":case"upa":{const e=c.value;-1===e?a.push(Ze(r)):sr(r)<=e?a.push({t:"null",v:void 0}):a.push(r[e]);break}case"dpa":a.push(Ar(r,c.value));break;case"ref":{const t=c.value;if(ne[t])a.push(tt(t));else if(_t(t,"$")){if(!e.get)return vr([{e:"External",m:'"get" feature not implemented on this platform',errCtx:o}]);const r=e.get(Vt(t,1));if("err"===r.kind)return vr([{e:"External",m:r.err,errCtx:o}]);a.push(r.value)}else t in e.env.vars?a.push(e.env.vars[t]):t in mr?a.push(mr[t]):t in e.env.funcs?a.push(tt(t)):vr([{e:"Reference",m:`"${t}" did not exist`,errCtx:o}]);break}case"exa":case"exe":{const s=a.pop(),u=hr(e,s,o,"exa"===c.typ),i=c.value,l=Ot(a,sr(a)-i,i);try{a.push(u(l))}catch(e){if(fr(e)){const r=St(t.ins,n).findIndex((e=>"cat"===e.typ));if(-1!==r){n+=r,mr.errors=Ze(br(e.errors));break}}throw e}lr&&(pr[sr(pr)-1]={},n=-1,r=lr,lr=void 0,--e.recurBudget,e.recurBudget||vr([{e:"Budget",m:"recurred too many times",errCtx:o}]));break}case"or":ce(a[sr(a)-1])?n+=c.value:a.pop();break;case"mat":{const e=a[sr(a)-2];nt(e,a.pop())?a.pop():n+=c.value;break}case"sat":{const t=a[sr(a)-2],r=hr(e,a.pop(),o);ce(r([t]))?a.pop():n+=c.value;break}case"if":ce(a.pop())||(n+=c.value);break;case"jmp":case"cat":n+=c.value;break;case"loo":n+=c.value,--e.loopBudget;break;case"pop":1===c.value?a.pop():Ot(a,sr(a)-c.value,c.value);break;case"ret":c.value||a.push({t:"null",v:void 0}),n=s;break;case"clo":{const s=St(c.value.derefs).map((t=>{const r="val"===t.typ&&"str"===t.value.t&&(mr[t.value.v]??e.env.vars[t.value.v]);return r?{typ:"val",value:r}:t})),o=gr(e,{ins:s},r,!0).v,u=St(t.ins,n+1,n+1+c.value.length);a.push({t:"clo",v:me(c.value,u,o)}),n+=c.value.length;break}}}return n?Ze(a):(pr.pop(),mr=pr[sr(pr)-1],a[sr(a)-1])}function Cr(e,t,r,n){const a=Re(t,r);if(sr(a.errors)&&vr(a.errors),e.env.funcs={...e.env.funcs,...a.funcs},"entry"in e.env.funcs)return gr(e,e.env.funcs.entry,n)}function kr(e,t,r,n=!1,a=[]){return function(e,t,r){const{callBudget:n,loopBudget:a,recurBudget:s,rangeBudget:c}=e;var o;o=e.functions,Object.keys(o).forEach((e=>{if(ne[e]&&!ne[e].external)throw"Redefining internal operations is disallowed.";ne[e]={...o[e].definition,external:!0}}));let u,i=[];try{u=t()}catch(e){if(!fr(e))throw e;i=e.errors}return[e.callBudget,e.recurBudget]=[n,s],[e.loopBudget,e.rangeBudget]=[a,c],delete e.env.funcs.entry,pr=[],sr(i)?{kind:"errors",errors:i}:(r&&u&&e.print(st(u),!0),u?{kind:"val",value:u}:{kind:"empty"})}(e,(()=>Cr(e,t,r,a)),n)}const $r=new Map,wr=/[\[\]\(\) ,]/;function jr(e,t,r,n=!0){r=r?`-${r}`:`${S()}`,$r.set(r,t);const a=kr(e,t,r,n);return{output:Er(a),result:a}}function Er(e){if("errors"!==e.kind)return[];let t=[];const r=e=>t.push({type:"message",text:e}),n=e=>t.push({type:"error",text:e});return e.errors.forEach((({e,m:t,errCtx:{line:a,col:s,invokeId:c}})=>{const u=$r.get(c);if(!u)return void r(`${e} Error: ${c} line ${a} col ${s}: ${t}\n`);const i=u.split("\n")[a-1],p=l(i,s-1).split(wr)[0],m=E(l(i,0,s-1)),v=d(c,"-")?`In ${l(c,1)}\n`:"";if(r(`\n${I(`${a}`,4)} ${m}`),p){const e=l(i,s-1+o(p));n(p),r(`${e}\n`)}else{const e=l(i,s);n(i[s-1]),r(`${e}\n`)}r(`${e} Error: ${t}.\n${v}`)})),t}window.insitux=t.invoker})();
//# sourceMappingURL=insitux.lib.min.js.map